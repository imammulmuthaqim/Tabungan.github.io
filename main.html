<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PremiumBank - Digital Banking Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut, updatePassword, updateEmail, reauthenticateWithCredential, EmailAuthProvider } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, set, get, update, push, onValue, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAu9GP9Ie1ohwunpapWBN7H8Kecby2v_qI",
            authDomain: "imsfinance-bf5fb.firebaseapp.com",
            databaseURL: "https://imsfinance-bf5fb-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "imsfinance-bf5fb",
            storageBucket: "imsfinance-bf5fb.firebasestorage.app",
            messagingSenderId: "752636802657",
            appId: "1:752636802657:web:ece790a75cd41660005c20"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Make Firebase functions available globally
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;
        window.onAuthStateChanged = onAuthStateChanged;
        window.signOut = signOut;
        window.updatePassword = updatePassword;
        window.updateEmail = updateEmail;
        window.reauthenticateWithCredential = reauthenticateWithCredential;
        window.EmailAuthProvider = EmailAuthProvider;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebaseUpdate = update;
        window.firebasePush = push;
        window.firebaseOnValue = onValue;
        window.firebaseServerTimestamp = serverTimestamp;
    </script>

    <!-- QR Code Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #3498db;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --text-muted: #bdc3c7;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #ecf0f1;
            --border-color: #e9ecef;
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-heavy: 0 10px 30px rgba(0, 0, 0, 0.15);
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            --danger-gradient: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-backdrop: blur(10px);
            --glass-border: rgba(255, 255, 255, 0.18);
        }

        [data-theme="dark"] {
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --text-muted: #7f8c8d;
            --bg-primary: #2c3e50;
            --bg-secondary: #34495e;
            --bg-tertiary: #3a4a5c;
            --border-color: #4a5a6a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }

        .loading-logo {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
        }

        .loading-text {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 2rem;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Login Required Screen */
        .login-required-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        .login-required-screen.show {
            display: flex;
        }

        .login-container {
            background: var(--glass-bg);
            backdrop-filter: var(--glass-backdrop);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: var(--shadow-heavy);
            text-align: center;
            max-width: 400px;
            width: 90%;
            color: white;
        }

        .login-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .login-subtitle {
            opacity: 0.9;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .login-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .login-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Dashboard */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .dashboard.active {
            display: block;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            padding: 1rem 2rem;
            box-shadow: var(--shadow-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-greeting {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle, .notification-btn, .logout-btn {
            background: none;
            border: none;
            padding: 0.75rem;
            border-radius: 50%;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            position: relative;
        }

        .theme-toggle:hover, .notification-btn:hover, .logout-btn:hover {
            background: var(--bg-secondary);
            color: var(--primary-color);
        }

        /* Main Content */
        .main-content {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-primary);
            box-shadow: var(--shadow-light);
            padding: 2rem 0;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 2rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            border-right: 3px solid transparent;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--bg-secondary);
            color: var(--primary-color);
            border-right-color: var(--primary-color);
        }

        .nav-link i {
            width: 20px;
            text-align: center;
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 2rem;
            background: var(--bg-secondary);
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-light);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Balance Card */
        .balance-card {
            background: var(--primary-gradient);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        .balance-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .balance-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .balance-amount {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .balance-label {
            opacity: 0.9;
            font-size: 1rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .quick-action {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            text-decoration: none;
            color: var(--text-primary);
            box-shadow: var(--shadow-light);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        .quick-action:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-heavy);
            color: var(--primary-color);
        }

        .quick-action i {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
        }

        .quick-action div {
            font-weight: 600;
        }

        /* Transactions */
        .transaction-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .transaction-icon.income {
            background: var(--secondary-color);
        }

        .transaction-icon.expense {
            background: var(--danger-color);
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .transaction-date {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .transaction-amount {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .transaction-amount.income {
            color: var(--secondary-color);
        }

        .transaction-amount.expense {
            color: var(--danger-color);
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin-right: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--secondary-gradient);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
        }

        .btn-danger {
            background: var(--danger-gradient);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-heavy);
        }

        /* Settings Panel */
        .settings-panel {
            max-width: 800px;
        }

        .settings-section {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }

        .settings-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .settings-title i {
            color: var(--primary-color);
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: 600;
            color: var(--text-primary);
        }

        .settings-value {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .settings-action {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .settings-action:hover {
            background: var(--primary-color);
            opacity: 0.9;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        #modalBody {
            padding: 2rem;
        }

        /* Transfer Steps */
        .transfer-step {
            display: none;
        }

        .transfer-step.active {
            display: block;
        }

        /* PIN Input */
        .pin-input-container {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin: 2rem 0;
        }

        .pin-digit {
            width: 50px;
            height: 50px;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: 600;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .pin-digit:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .pin-digit.filled {
            border-color: var(--secondary-color);
            background: rgba(46, 204, 113, 0.1);
        }

        /* QR Code */
        .qr-container {
            text-align: center;
        }

        .qr-code-display {
            display: flex;
            justify-content: center;
            margin: 2rem 0;
        }

        .qr-scanner-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto;
            border-radius: 16px;
            overflow: hidden;
        }

        .qr-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .qr-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid var(--primary-color);
            border-radius: 16px;
            pointer-events: none;
        }

        /* Recipient Card */
        .recipient-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .recipient-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .recipient-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .recipient-details h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .recipient-details p {
            margin: 0.25rem 0 0 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Amount Input */
        .amount-input-container {
            text-align: center;
            margin: 2rem 0;
        }

        .amount-input {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            border: none;
            background: transparent;
            color: var(--text-primary);
            width: 100%;
            padding: 1rem;
        }

        .amount-input:focus {
            outline: none;
        }

        .amount-shortcuts {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .amount-shortcut {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .amount-shortcut:hover {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }

        /* Service Grid */
        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .service-card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-heavy);
        }

        .service-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .service-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .service-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Investment Cards */
        .investment-card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .investment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .investment-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .investment-return {
            font-weight: 700;
            color: var(--secondary-color);
        }

        .investment-return.negative {
            color: var(--danger-color);
        }

        .investment-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .investment-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Credit Card */
        .credit-card {
            background: var(--primary-gradient);
            border-radius: 16px;
            padding: 2rem;
            color: white;
            position: relative;
            overflow: hidden;
            margin-bottom: 2rem;
            min-height: 200px;
        }

        .credit-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        .card-number {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.2rem;
            margin: 2rem 0 1rem 0;
        }

        .card-info {
            display: flex;
            justify-content: space-between;
            align-items: end;
        }

        .card-holder {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .card-expiry {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .card-brand {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            opacity: 0.8;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 200;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .content-area {
                padding: 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }

            .balance-amount {
                font-size: 2rem;
            }

            .pin-input-container {
                gap: 0.25rem;
            }

            .pin-digit {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            .service-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(180deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-in-right {
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        /* Status Indicators */
        .status-online {
            color: var(--secondary-color);
        }

        .status-offline {
            color: var(--text-muted);
        }

        .status-pending {
            color: var(--warning-color);
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--secondary-color);
            animation: spin 1s ease-in-out infinite;
        }

        /* Success/Error Messages */
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .message.success {
            background: rgba(46, 204, 113, 0.1);
            color: var(--secondary-color);
            border: 1px solid rgba(46, 204, 113, 0.2);
        }

        .message.error {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(231, 76, 60, 0.2);
        }

        .message.warning {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(243, 156, 18, 0.2);
        }

        .message.info {
            background: rgba(52, 152, 219, 0.1);
            color: var(--info-color);
            border: 1px solid rgba(52, 152, 219, 0.2);
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }

            .user-greeting {
                display: none;
            }
        }

        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 199;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <i class="fas fa-university"></i>
        </div>
        <div class="loading-text">PremiumBank</div>
        <div class="loading-spinner"></div>
    </div>

    <!-- Login Required Screen -->
    <div class="login-required-screen" id="loginRequiredScreen">
        <div class="login-container">
            <div class="login-title">Access Denied</div>
            <div class="login-subtitle">Please login to access your dashboard</div>
            <a href="index.html" class="login-btn">
                <i class="fas fa-sign-in-alt"></i> Go to Login
            </a>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="mobile-menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <i class="fas fa-university"></i> PremiumBank
                </div>
                <div class="user-greeting" id="userGreeting">
                    Welcome back, User!
                </div>
            </div>
            <div class="header-right">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="notification-btn" onclick="showNotifications()" title="Notifications" style="position: relative;">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationBadge">0</span>
                </button>
                <button class="logout-btn" onclick="logout()" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <nav class="sidebar" id="sidebar">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" onclick="showSection('dashboard')">
                            <i class="fas fa-home"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('transfer')">
                            <i class="fas fa-exchange-alt"></i>
                            <span>Transfer</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('topup')">
                            <i class="fas fa-mobile-alt"></i>
                            <span>Top Up</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('bills')">
                            <i class="fas fa-file-invoice"></i>
                            <span>Bills</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('transactions')">
                            <i class="fas fa-list"></i>
                            <span>Transactions</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('investments')">
                            <i class="fas fa-chart-line"></i>
                            <span>Investments</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('cards')">
                            <i class="fas fa-credit-card"></i>
                            <span>My Cards</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('settings')">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" onclick="showSection('support')">
                            <i class="fas fa-headset"></i>
                            <span>Support</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Content Area -->
            <main class="content-area">
                <!-- Dashboard Section -->
                <div id="dashboardSection" class="content-section active">
                    <!-- Dashboard Grid -->
                    <div class="dashboard-grid">
                        <!-- Balance Card -->
                        <div class="card balance-card">
                            <button class="balance-toggle" onclick="toggleBalance()" title="Toggle Balance Visibility">
                                <i class="fas fa-eye" id="balanceToggleIcon"></i>
                            </button>
                            <div class="balance-amount" id="balanceAmount">Rp 2,500,000</div>
                            <div class="balance-label">Total Balance</div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">This Month</div>
                                <div class="card-icon" style="background: var(--secondary-color);">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                            </div>
                            <div class="balance-amount" style="color: var(--secondary-color); font-size: 1.8rem;" id="monthlyIncome">
                                +Rp 5,200,000
                            </div>
                            <div class="balance-label" style="color: var(--text-secondary);">Income</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">This Month</div>
                                <div class="card-icon" style="background: var(--danger-color);">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                            </div>
                            <div class="balance-amount" style="color: var(--danger-color); font-size: 1.8rem;" id="monthlyExpense">
                                -Rp 2,700,000
                            </div>
                            <div class="balance-label" style="color: var(--text-secondary);">Expenses</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <div class="quick-action" onclick="showSection('transfer')">
                            <i class="fas fa-paper-plane"></i>
                            <div>Transfer</div>
                        </div>
                        <div class="quick-action" onclick="showSection('topup')">
                            <i class="fas fa-mobile-alt"></i>
                            <div>Top Up</div>
                        </div>
                        <div class="quick-action" onclick="showQROptions()">
                            <i class="fas fa-qrcode"></i>
                            <div>QR Pay</div>
                        </div>
                        <div class="quick-action" onclick="showSection('bills')">
                            <i class="fas fa-file-invoice"></i>
                            <div>Bills</div>
                        </div>
                        <div class="quick-action" onclick="showSection('investments')">
                            <i class="fas fa-chart-pie"></i>
                            <div>Invest</div>
                        </div>
                        <div class="quick-action" onclick="showSection('cards')">
                            <i class="fas fa-credit-card"></i>
                            <div>Cards</div>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="card" style="margin-top: 2rem;">
                        <div class="card-header">
                            <div class="card-title">Recent Transactions</div>
                            <a href="#" onclick="showSection('transactions')" style="color: var(--secondary-color); text-decoration: none; font-weight: 500;">View All</a>
                        </div>
                        <div id="recentTransactions">
                            <div class="transaction-item">
                                <div class="transaction-icon income">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                                <div class="transaction-details">
                                    <div class="transaction-title">Transfer dari John Doe</div>
                                    <div class="transaction-date">Today, 14:30</div>
                                </div>
                                <div class="transaction-amount income">+Rp 500,000</div>
                            </div>
                            <div class="transaction-item">
                                <div class="transaction-icon expense">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                                <div class="transaction-details">
                                    <div class="transaction-title">Top Up Pulsa</div>
                                    <div class="transaction-date">Yesterday, 09:15</div>
                                </div>
                                <div class="transaction-amount expense">-Rp 50,000</div>
                            </div>
                            <div class="transaction-item">
                                <div class="transaction-icon expense">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="transaction-details">
                                    <div class="transaction-title">Pembayaran E-commerce</div>
                                    <div class="transaction-date">2 days ago, 16:45</div>
                                </div>
                                <div class="transaction-amount expense">-Rp 250,000</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transfer Section -->
                <div id="transferSection" class="content-section">
                    <div class="card">
                        <div class="card-title">Transfer Dana</div>
                        <div class="transfer-step active" id="transferStep1">
                            <p>Masukkan nomor telepon penerima untuk mencari pengguna.</p>
                            <div class="form-group">
                                <label class="form-label">Nomor Telepon Penerima</label>
                                <input type="tel" class="form-input" id="recipientPhone" placeholder="+62812345678" required>
                            </div>
                            <button class="btn btn-primary" onclick="searchRecipient()">Cari Penerima</button>
                        </div>

                        <div class="transfer-step" id="transferStep2">
                            <p>Konfirmasi detail penerima dan masukkan jumlah transfer.</p>
                            <div class="recipient-card">
                                <div class="recipient-info">
                                    <div class="recipient-avatar" id="recipientAvatar"></div>
                                    <div class="recipient-details">
                                        <h3 id="recipientName"></h3>
                                        <p id="recipientPhoneDisplay"></p>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Jumlah Transfer</label>
                                <input type="number" class="form-input" id="transferAmount" placeholder="Rp 0" required min="1000">
                            </div>
                            <div class="amount-shortcuts">
                                <button class="amount-shortcut" onclick="addAmount(10000)">Rp 10rb</button>
                                <button class="amount-shortcut" onclick="addAmount(50000)">Rp 50rb</button>
                                <button class="amount-shortcut" onclick="addAmount(100000)">Rp 100rb</button>
                                <button class="amount-shortcut" onclick="addAmount(500000)">Rp 500rb</button>
                            </div>
                            <div class="form-group" style="margin-top: 1.5rem;">
                                <button class="btn btn-primary" onclick="confirmTransfer()">Transfer Sekarang</button>
                                <button class="btn btn-secondary" onclick="resetTransfer()">Batal</button>
                            </div>
                        </div>

                        <div class="transfer-step" id="transferStep3">
                            <p>Masukkan PIN Transaksi Anda untuk menyelesaikan transfer.</p>
                            <div class="pin-input-container">
                                <input type="password" class="pin-digit" maxlength="1" id="pinTransfer1">
                                <input type="password" class="pin-digit" maxlength="1" id="pinTransfer2">
                                <input type="password" class="pin-digit" maxlength="1" id="pinTransfer3">
                                <input type="password" class="pin-digit" maxlength="1" id="pinTransfer4">
                                <input type="password" class="pin-digit" maxlength="1" id="pinTransfer5">
                                <input type="password" class="pin-digit" maxlength="1" id="pinTransfer6">
                            </div>
                            <div class="form-group">
                                <button class="btn btn-primary" onclick="executeTransfer()">Konfirmasi Transfer</button>
                                <button class="btn btn-secondary" onclick="resetTransfer()">Batal</button>
                            </div>
                        </div>

                        <div class="transfer-step" id="transferStep4">
                            <div style="text-align: center; margin-bottom: 2rem;">
                                <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--secondary-color); margin-bottom: 1rem;"></i>
                                <h2 style="color: var(--secondary-color); margin-bottom: 0.5rem;">Transfer Berhasil!</h2>
                                <p style="color: var(--text-secondary);">Dana telah berhasil dikirim ke penerima</p>
                            </div>
                            <div class="card" style="background: var(--bg-secondary);">
                                <div class="card-title">Detail Transaksi</div>
                                <div style="display: grid; gap: 1rem;">
                                    <div style="display: flex; justify-content: space-between;">
                                        <span><strong>Penerima:</strong></span>
                                        <span id="finalRecipientName"></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span><strong>Nomor Telepon:</strong></span>
                                        <span id="finalRecipientPhone"></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span><strong>Jumlah:</strong></span>
                                        <span id="finalTransferAmount" style="color: var(--danger-color); font-weight: 700;"></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span><strong>Tanggal:</strong></span>
                                        <span id="finalTransferDate"></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span><strong>Waktu:</strong></span>
                                        <span id="finalTransferTime"></span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span><strong>Nomor Pesanan:</strong></span>
                                        <span id="finalOrderId" style="font-family: monospace; font-size: 0.9rem;"></span>
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 2rem;">
                                <button class="btn btn-primary" onclick="resetTransfer()">Selesai</button>
                                <button class="btn btn-secondary" onclick="shareReceipt()">Bagikan Bukti</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Up Section -->
                <div id="topupSection" class="content-section">
                    <div class="card">
                        <div class="card-title">Top Up Saldo</div>
                        <div class="service-grid">
                            <div class="service-card" onclick="showTopUpForm('bank')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--primary-gradient);">
                                        <i class="fas fa-university"></i>
                                    </div>
                                    <div class="service-title">Transfer Bank</div>
                                </div>
                                <p>Top up melalui transfer bank virtual account</p>
                            </div>
                            <div class="service-card" onclick="showTopUpForm('ewallet')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--secondary-gradient);">
                                        <i class="fas fa-wallet"></i>
                                    </div>
                                    <div class="service-title">E-Wallet</div>
                                </div>
                                <p>Top up menggunakan GoPay, OVO, DANA, dll</p>
                            </div>
                            <div class="service-card" onclick="showTopUpForm('card')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--danger-gradient);">
                                        <i class="fas fa-credit-card"></i>
                                    </div>
                                    <div class="service-title">Kartu Kredit/Debit</div>
                                </div>
                                <p>Top up langsung dengan kartu kredit atau debit</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bills Section -->
                <div id="billsSection" class="content-section">
                    <div class="card">
                        <div class="card-title">Pembayaran Tagihan</div>
                        <div class="service-grid">
                            <div class="service-card" onclick="showBillForm('electricity')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--warning-color);">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                    <div class="service-title">Listrik PLN</div>
                                </div>
                                <p>Bayar tagihan listrik PLN</p>
                            </div>
                            <div class="service-card" onclick="showBillForm('water')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--info-color);">
                                        <i class="fas fa-tint"></i>
                                    </div>
                                    <div class="service-title">Air PDAM</div>
                                </div>
                                <p>Bayar tagihan air PDAM</p>
                            </div>
                            <div class="service-card" onclick="showBillForm('internet')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--primary-gradient);">
                                        <i class="fas fa-wifi"></i>
                                    </div>
                                    <div class="service-title">Internet & TV</div>
                                </div>
                                <p>Bayar tagihan internet dan TV kabel</p>
                            </div>
                            <div class="service-card" onclick="showBillForm('phone')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--secondary-gradient);">
                                        <i class="fas fa-mobile-alt"></i>
                                    </div>
                                    <div class="service-title">Pulsa & Paket Data</div>
                                </div>
                                <p>Beli pulsa dan paket data</p>
                            </div>
                            <div class="service-card" onclick="showBillForm('insurance')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--danger-gradient);">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <div class="service-title">Asuransi</div>
                                </div>
                                <p>Bayar premi asuransi</p>
                            </div>
                            <div class="service-card" onclick="showBillForm('tax')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--text-secondary);">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                    </div>
                                    <div class="service-title">Pajak</div>
                                </div>
                                <p>Bayar pajak kendaraan dan lainnya</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transactions Section -->
                <div id="transactionsSection" class="content-section">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Riwayat Transaksi</div>
                            <div>
                                <select class="form-select" style="width: auto; display: inline-block;" onchange="filterTransactions(this.value)">
                                    <option value="all">Semua Transaksi</option>
                                    <option value="income">Pemasukan</option>
                                    <option value="expense">Pengeluaran</option>
                                </select>
                            </div>
                        </div>
                        <div id="transactionsList">
                            <div class="transaction-item">
                                <div class="transaction-icon income">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                                <div class="transaction-details">
                                    <div class="transaction-title">Transfer dari John Doe</div>
                                    <div class="transaction-date">Today, 14:30  TXN-20241219-001</div>
                                </div>
                                <div class="transaction-amount income">+Rp 500,000</div>
                            </div>
                            <div class="transaction-item">
                                <div class="transaction-icon expense">
                                    <i class="fas fa-mobile-alt"></i>
                                </div>
                                <div class="transaction-details">
                                    <div class="transaction-title">Top Up Pulsa Telkomsel</div>
                                    <div class="transaction-date">Yesterday, 09:15  TXN-20241218-045</div>
                                </div>
                                <div class="transaction-amount expense">-Rp 50,000</div>
                            </div>
                            <div class="transaction-item">
                                <div class="transaction-icon expense">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="transaction-details">
                                    <div class="transaction-title">Pembayaran E-commerce</div>
                                    <div class="transaction-date">2 days ago, 16:45  TXN-20241217-123</div>
                                </div>
                                <div class="transaction-amount expense">-Rp 250,000</div>
                            </div>
                            <div class="transaction-item">
                                <div class="transaction-icon expense">
                                    <i class="fas fa-bolt"></i>
                                </div>
                                <div class="transaction-details">
                                    <div class="transaction-title">Bayar Listrik PLN</div>
                                    <div class="transaction-date">3 days ago, 11:20  TXN-20241216-089</div>
                                </div>
                                <div class="transaction-amount expense">-Rp 150,000</div>
                            </div>
                            <div class="transaction-item">
                                <div class="transaction-icon income">
                                    <i class="fas fa-briefcase"></i>
                                </div>
                                <div class="transaction-details">
                                    <div class="transaction-title">Gaji Bulanan</div>
                                    <div class="transaction-date">1 week ago, 08:00  TXN-20241212-001</div>
                                </div>
                                <div class="transaction-amount income">+Rp 5,000,000</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Investments Section -->
                <div id="investmentsSection" class="content-section">
                    <div class="card">
                        <div class="card-title">Portfolio Investasi</div>
                        <div class="investment-card">
                            <div class="investment-header">
                                <div class="investment-name">Reksa Dana Saham</div>
                                <div class="investment-return">+12.5%</div>
                            </div>
                            <div class="investment-description">
                                Investasi jangka panjang dengan potensi return tinggi
                            </div>
                            <div class="investment-actions">
                                <button class="btn btn-primary" onclick="investMore('saham')">Investasi Lagi</button>
                                <button class="btn btn-secondary" onclick="viewInvestmentDetail('saham')">Detail</button>
                            </div>
                        </div>
                        
                        <div class="investment-card">
                            <div class="investment-header">
                                <div class="investment-name">Emas Digital</div>
                                <div class="investment-return">+8.2%</div>
                            </div>
                            <div class="investment-description">
                                Investasi emas digital yang aman dan stabil
                            </div>
                            <div class="investment-actions">
                                <button class="btn btn-primary" onclick="investMore('emas')">Investasi Lagi</button>
                                <button class="btn btn-secondary" onclick="viewInvestmentDetail('emas')">Detail</button>
                            </div>
                        </div>

                        <div class="investment-card">
                            <div class="investment-header">
                                <div class="investment-name">Obligasi Pemerintah</div>
                                <div class="investment-return">+6.8%</div>
                            </div>
                            <div class="investment-description">
                                Investasi dengan risiko rendah dan return stabil
                            </div>
                            <div class="investment-actions">
                                <button class="btn btn-primary" onclick="investMore('obligasi')">Investasi Lagi</button>
                                <button class="btn btn-secondary" onclick="viewInvestmentDetail('obligasi')">Detail</button>
                            </div>
                        </div>

                        <div class="investment-card">
                            <div class="investment-header">
                                <div class="investment-name">Cryptocurrency</div>
                                <div class="investment-return negative">-3.2%</div>
                            </div>
                            <div class="investment-description">
                                Investasi kripto dengan volatilitas tinggi
                            </div>
                            <div class="investment-actions">
                                <button class="btn btn-primary" onclick="investMore('crypto')">Investasi Lagi</button>
                                <button class="btn btn-secondary" onclick="viewInvestmentDetail('crypto')">Detail</button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title">Investasi Baru</div>
                        <div class="service-grid">
                            <div class="service-card" onclick="startNewInvestment('saham')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--primary-gradient);">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="service-title">Reksa Dana Saham</div>
                                </div>
                                <p>Mulai investasi reksa dana saham</p>
                            </div>
                            <div class="service-card" onclick="startNewInvestment('emas')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--warning-color);">
                                        <i class="fas fa-coins"></i>
                                    </div>
                                    <div class="service-title">Emas Digital</div>
                                </div>
                                <p>Investasi emas digital yang mudah</p>
                            </div>
                            <div class="service-card" onclick="startNewInvestment('obligasi')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--secondary-gradient);">
                                        <i class="fas fa-certificate"></i>
                                    </div>
                                    <div class="service-title">Obligasi</div>
                                </div>
                                <p>Investasi obligasi pemerintah</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cards Section -->
                <div id="cardsSection" class="content-section">
                    <div class="card">
                        <div class="card-title">Kartu Saya</div>
                        
                        <!-- Credit Card Display -->
                        <div class="credit-card">
                            <div class="card-brand">
                                <i class="fab fa-cc-visa"></i>
                            </div>
                            <div class="card-number">**** **** **** 1234</div>
                            <div class="card-info">
                                <div>
                                    <div class="card-holder">JOHN DOE</div>
                                </div>
                                <div>
                                    <div class="card-expiry">12/26</div>
                                </div>
                            </div>
                        </div>

                        <!-- Card Actions -->
                        <div class="service-grid">
                            <div class="service-card" onclick="showCardAction('block')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--danger-gradient);">
                                        <i class="fas fa-ban"></i>
                                    </div>
                                    <div class="service-title">Blokir Kartu</div>
                                </div>
                                <p>Blokir kartu jika hilang atau dicuri</p>
                            </div>
                            <div class="service-card" onclick="showCardAction('limit')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--primary-gradient);">
                                        <i class="fas fa-cog"></i>
                                    </div>
                                    <div class="service-title">Atur Limit</div>
                                </div>
                                <p>Atur limit transaksi harian</p>
                            </div>
                            <div class="service-card" onclick="showCardAction('pin')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--secondary-gradient);">
                                        <i class="fas fa-key"></i>
                                    </div>
                                    <div class="service-title">Ganti PIN</div>
                                </div>
                                <p>Ubah PIN kartu ATM/Debit</p>
                            </div>
                            <div class="service-card" onclick="showCardAction('statement')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--info-color);">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div class="service-title">Mutasi Kartu</div>
                                </div>
                                <p>Lihat riwayat transaksi kartu</p>
                            </div>
                            <div class="service-card" onclick="showCardAction('new')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--warning-color);">
                                        <i class="fas fa-plus"></i>
                                    </div>
                                    <div class="service-title">Kartu Baru</div>
                                </div>
                                <p>Ajukan kartu kredit/debit baru</p>
                            </div>
                            <div class="service-card" onclick="showCardAction('virtual')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--text-secondary);">
                                        <i class="fas fa-mobile-alt"></i>
                                    </div>
                                    <div class="service-title">Kartu Virtual</div>
                                </div>
                                <p>Buat kartu virtual untuk belanja online</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settingsSection" class="content-section settings-panel">
                    <!-- Account Settings -->
                    <div class="settings-section">
                        <div class="settings-title">
                            <i class="fas fa-user"></i>
                            Account Information
                        </div>
                        <div class="settings-item">
                            <div>
                                <div class="settings-label">Full Name</div>
                                <div class="settings-value" id="userFullName">John Doe</div>
                            </div>
                            <button class="settings-action" onclick="editProfile()">Edit</button>
                        </div>
                        <div class="settings-item">
                            <div>
                                <div class="settings-label">Email Address</div>
                                <div class="settings-value" id="userEmail">john.doe@example.com</div>
                            </div>
                            <button class="settings-action" onclick="editEmail()">Change</button>
                        </div>
                        <div class="settings-item">
                            <div>
                                <div class="settings-label">Phone Number</div>
                                <div class="settings-value" id="userPhone">+62812345678</div>
                            </div>
                            <button class="settings-action" onclick="editPhone()">Change</button>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="settings-section">
                        <div class="settings-title">
                            <i class="fas fa-shield-alt"></i>
                            Security & Privacy
                        </div>
                        <div class="settings-item">
                            <div>
                                <div class="settings-label">Transaction PIN</div>
                                <div class="settings-value status-online" id="pinStatus">Set</div>
                            </div>
                            <button class="settings-action" onclick="changePIN()">Change PIN</button>
                        </div>
                        <div class="settings-item">
                            <div>
                                <div class="settings-label">Password</div>
                                <div class="settings-value">Last changed 30 days ago</div>
                            </div>
                            <button class="settings-action" onclick="changePassword()">Change</button>
                        </div>
                        <div class="settings-item">
                            <div>
                                <div class="settings-label">Two-Factor Authentication</div>
                                <div class="settings-value status-online">Enabled</div>
                            </div>
                            <button class="settings-action" onclick="toggle2FA()">Manage</button>
                        </div>
                    </div>
                </div>

                <!-- Support Section -->
                <div id="supportSection" class="content-section">
                    <div class="card">
                        <div class="card-title">Customer Support</div>
                        <div class="service-grid">
                            <div class="service-card" onclick="contactSupport('chat')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--primary-gradient);">
                                        <i class="fas fa-comments"></i>
                                    </div>
                                    <div class="service-title">Live Chat</div>
                                </div>
                                <p>Chat langsung dengan customer service</p>
                            </div>
                            <div class="service-card" onclick="contactSupport('phone')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--secondary-gradient);">
                                        <i class="fas fa-phone"></i>
                                    </div>
                                    <div class="service-title">Call Center</div>
                                </div>
                                <p>Hubungi call center 24/7</p>
                            </div>
                            <div class="service-card" onclick="contactSupport('email')">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--info-color);">
                                        <i class="fas fa-envelope"></i>
                                    </div>
                                    <div class="service-title">Email Support</div>
                                </div>
                                <p>Kirim email ke support team</p>
                            </div>
                            <div class="service-card" onclick="showFAQ()">
                                <div class="service-header">
                                    <div class="service-icon" style="background: var(--warning-color);">
                                        <i class="fas fa-question-circle"></i>
                                    </div>
                                    <div class="service-title">FAQ</div>
                                </div>
                                <p>Pertanyaan yang sering diajukan</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal for various actions -->
    <div class="modal" id="actionModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Action</div>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Modal content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let balanceVisible = true;
        let isDarkTheme = false;
        let userBalance = 2500000;
        let recipientData = null;
        let transferAmount = 0;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initializeApp, 2000);
        });

        function initializeApp() {
            console.log('Initializing main dashboard...');
            
            document.getElementById('loadingScreen').style.display = 'none';
            
            if (typeof window.firebaseAuth === 'undefined') {
                console.log('Firebase still loading...');
                setTimeout(initializeApp, 500);
                return;
            }

            console.log('Firebase loaded, checking authentication...');

            window.onAuthStateChanged(window.firebaseAuth, (user) => {
                console.log('Auth state changed:', user ? 'User logged in' : 'No user');
                
                if (user) {
                    currentUser = user;
                    console.log('Authenticated user:', user.email);
                    showDashboard();
                    loadUserData();
                } else {
                    console.log('No authenticated user, showing login required screen');
                    showLoginRequired();
                }
            });
        }

        function showLoginRequired() {
            document.getElementById('loginRequiredScreen').classList.add('show');
            document.getElementById('dashboard').classList.remove('active');
        }

        function showDashboard() {
            console.log('Showing dashboard for user:', currentUser.email);
            document.getElementById('loginRequiredScreen').classList.remove('show');
            document.getElementById('dashboard').classList.add('active');
        }

        async function loadUserData() {
            if (currentUser) {
                console.log('Loading user data for:', currentUser.email);
                
                try {
                    // Get user data from Firebase
                    const userRef = window.firebaseRef(window.firebaseDatabase, `users/${currentUser.uid}`);
                    const snapshot = await window.firebaseGet(userRef);
                    
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        
                        // Update UI with user data
                        const displayName = userData.displayName || currentUser.displayName || currentUser.email.split('@')[0];
                        document.getElementById('userGreeting').textContent = `Welcome back, ${displayName}!`;
                        document.getElementById('userFullName').textContent = displayName;
                        document.getElementById('userEmail').textContent = currentUser.email;
                        document.getElementById('userPhone').textContent = userData.phoneNumber || '+62812345678';
                        
                        // Update balance
                        userBalance = userData.balance || 0;
                        updateBalanceDisplay();
                        
                        // Update monthly stats
                        document.getElementById('monthlyIncome').textContent = formatCurrency(userData.monthlyIncome || 0);
                        document.getElementById('monthlyExpense').textContent = formatCurrency(userData.monthlyExpense || 0);
                        
                        // Load recent transactions
                        loadRecentTransactions();
                        
                    } else {
                        // Initialize new user data
                        const newUserData = {
                            email: currentUser.email,
                            displayName: currentUser.displayName || currentUser.email.split('@')[0],
                            phoneNumber: '+62812345678', // Default phone number
                            balance: 0,
                            monthlyIncome: 0,
                            monthlyExpense: 0,
                            transactionPin: '123456', // Default PIN (should be hashed in production)
                            twoFactorEnabled: false,
                            createdAt: new Date().toISOString()
                        };
                        
                        await window.firebaseSet(userRef, newUserData);
                        
                        // Update UI with default data
                        document.getElementById('userGreeting').textContent = `Welcome, ${newUserData.displayName}!`;
                        document.getElementById('userFullName').textContent = newUserData.displayName;
                        document.getElementById('userEmail').textContent = currentUser.email;
                        document.getElementById('userPhone').textContent = newUserData.phoneNumber;
                        
                        userBalance = 0;
                        updateBalanceDisplay();
                        
                        showMessage("Selamat datang! Akun baru Anda telah dibuat.", "success");
                    }
                } catch (error) {
                    console.error('Error loading user data:', error);
                    showMessage("Terjadi kesalahan saat memuat data pengguna.", "error");
                }
            }
        }

        async function loadRecentTransactions() {
            if (!currentUser) return;
            
            try {
                const userTransactionsRef = window.firebaseRef(window.firebaseDatabase, `userTransactions/${currentUser.uid}`);
                const snapshot = await window.firebaseGet(userTransactionsRef);
                
                const recentTransactionsContainer = document.getElementById('recentTransactions');
                
                if (snapshot.exists()) {
                    const transactions = snapshot.val();
                    const transactionArray = Object.values(transactions).sort((a, b) => 
                        new Date(b.createdAt) - new Date(a.createdAt)
                    ).slice(0, 5); // Get latest 5 transactions
                    
                    recentTransactionsContainer.innerHTML = '';
                    
                    transactionArray.forEach(transaction => {
                        const transactionElement = createTransactionElement(transaction);
                        recentTransactionsContainer.appendChild(transactionElement);
                    });
                } else {
                    recentTransactionsContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Belum ada transaksi</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading recent transactions:', error);
            }
        }

        function createTransactionElement(transaction) {
            const div = document.createElement('div');
            div.className = 'transaction-item';
            
            const isIncoming = transaction.direction === 'incoming';
            const iconClass = isIncoming ? 'income' : 'expense';
            const amountClass = isIncoming ? 'income' : 'expense';
            const amountPrefix = isIncoming ? '+' : '-';
            
            let icon = 'fas fa-exchange-alt';
            if (transaction.type === 'topup') icon = 'fas fa-plus';
            else if (transaction.type === 'bill') icon = 'fas fa-file-invoice';
            else if (transaction.type === 'investment') icon = 'fas fa-chart-line';
            
            div.innerHTML = `
                <div class="transaction-icon ${iconClass}">
                    <i class="${icon}"></i>
                </div>
                <div class="transaction-details">
                    <div class="transaction-title">${transaction.description}</div>
                    <div class="transaction-date">${formatTransactionDate(transaction.createdAt)}</div>
                </div>
                <div class="transaction-amount ${amountClass}">${amountPrefix}${formatCurrency(transaction.amount)}</div>
            `;
            
            return div;
        }

        function formatTransactionDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                return `Today, ${date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
            } else if (diffDays === 2) {
                return `Yesterday, ${date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
            } else if (diffDays <= 7) {
                return `${diffDays - 1} days ago, ${date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
            } else {
                return date.toLocaleDateString('id-ID') + ', ' + date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            }
        }

        function updateBalanceDisplay() {
            const balanceElement = document.getElementById('balanceAmount');
            
            if (balanceVisible) {
                balanceElement.textContent = formatCurrency(userBalance);
            } else {
                balanceElement.textContent = '';
            }
        }

        // Navigation functions
        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
                section.classList.remove('active');
            });

            const targetSection = document.getElementById(sectionName + 'Section');
            if (targetSection) {
                targetSection.style.display = 'block';
                targetSection.classList.add('active');
            }

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                if (link.getAttribute('onclick') && link.getAttribute('onclick').includes(sectionName)) {
                    link.classList.add('active');
                }
            });

            // Close mobile sidebar
            if (window.innerWidth <= 768) {
                toggleSidebar();
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function toggleBalance() {
            const toggleIcon = document.getElementById('balanceToggleIcon');
            
            balanceVisible = !balanceVisible;
            
            if (balanceVisible) {
                toggleIcon.className = 'fas fa-eye';
            } else {
                toggleIcon.className = 'fas fa-eye-slash';
            }
            
            updateBalanceDisplay();
        }

        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.querySelector('.theme-toggle i');
            
            isDarkTheme = !isDarkTheme;
            
            if (isDarkTheme) {
                body.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-sun';
            } else {
                body.removeAttribute('data-theme');
                themeIcon.className = 'fas fa-moon';
            }
        }

        // Transfer functions
        async function searchRecipient() {
            const phone = document.getElementById("recipientPhone").value.trim();
            if (!phone) {
                showMessage("Masukkan nomor telepon penerima.", "warning");
                return;
            }

            // Normalize phone number format
            let normalizedPhone = phone;
            if (phone.startsWith('0')) {
                normalizedPhone = '+62' + phone.substring(1);
            } else if (!phone.startsWith('+62')) {
                normalizedPhone = '+62' + phone;
            }

            if (normalizedPhone === document.getElementById("userPhone").textContent) {
                showMessage("Tidak dapat transfer ke nomor sendiri.", "error");
                return;
            }

            showMessage("Mencari penerima...", "info");

            try {
                // Search for user by phone number in Firebase
                const usersRef = window.firebaseRef(window.firebaseDatabase, 'users');
                const snapshot = await window.firebaseGet(usersRef);
                
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    let foundUser = null;
                    
                    // Search through all users to find matching phone number
                    for (const [userId, userData] of Object.entries(users)) {
                        if (userData.phoneNumber === normalizedPhone) {
                            foundUser = {
                                uid: userId,
                                displayName: userData.displayName || userData.email.split('@')[0],
                                phoneNumber: userData.phoneNumber,
                                email: userData.email
                            };
                            break;
                        }
                    }

                    if (foundUser) {
                        recipientData = foundUser;
                        
                        document.getElementById("recipientName").textContent = recipientData.displayName;
                        document.getElementById("recipientPhoneDisplay").textContent = recipientData.phoneNumber;
                        document.getElementById("recipientAvatar").textContent = recipientData.displayName[0].toUpperCase();

                        showTransferStep(2);
                        showMessage("Penerima ditemukan!", "success");
                    } else {
                        showMessage("Nomor telepon tidak terdaftar dalam sistem.", "error");
                    }
                } else {
                    showMessage("Tidak ada pengguna yang terdaftar.", "error");
                }
            } catch (error) {
                console.error("Error searching recipient:", error);
                showMessage("Terjadi kesalahan saat mencari penerima.", "error");
            }
        }

        function showTransferStep(step) {
            document.querySelectorAll(".transfer-step").forEach(s => s.classList.remove("active"));
            document.getElementById(`transferStep${step}`).classList.add("active");
        }

        function addAmount(amount) {
            const currentAmount = parseInt(document.getElementById("transferAmount").value) || 0;
            document.getElementById("transferAmount").value = currentAmount + amount;
        }

        function confirmTransfer() {
            transferAmount = parseInt(document.getElementById("transferAmount").value);
            if (isNaN(transferAmount) || transferAmount <= 0) {
                showMessage("Masukkan jumlah transfer yang valid.", "warning");
                return;
            }

            if (userBalance < transferAmount) {
                showMessage("Saldo tidak mencukupi.", "error");
                return;
            }

            showTransferStep(3);
            document.querySelectorAll(".pin-digit").forEach(input => input.value = "");
            document.getElementById("pinTransfer1").focus();
        }

        async function executeTransfer() {
            const enteredPin = Array.from(document.querySelectorAll("#transferStep3 .pin-digit")).map(input => input.value).join("");
            if (enteredPin.length !== 6) {
                showMessage("Masukkan PIN 6 digit lengkap.", "warning");
                return;
            }

            showMessage("Memverifikasi PIN dan memproses transfer...", "info");

            try {
                // Get current user's PIN from Firebase
                const userRef = window.firebaseRef(window.firebaseDatabase, `users/${currentUser.uid}`);
                const userSnapshot = await window.firebaseGet(userRef);
                
                if (!userSnapshot.exists()) {
                    showMessage("Data pengguna tidak ditemukan.", "error");
                    return;
                }

                const userData = userSnapshot.val();
                
                // Verify PIN (in real app, this should be hashed)
                if (userData.transactionPin !== enteredPin) {
                    showMessage("PIN salah. Coba lagi.", "error");
                    return;
                }

                // Check if user has sufficient balance
                if (userData.balance < transferAmount) {
                    showMessage("Saldo tidak mencukupi.", "error");
                    return;
                }

                // Generate transaction ID
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                const timeStr = now.getTime().toString().slice(-3);
                const transactionId = `TXN-${dateStr}-${timeStr}`;

                // Prepare transaction data
                const transactionData = {
                    id: transactionId,
                    senderId: currentUser.uid,
                    senderName: userData.displayName || currentUser.email.split('@')[0],
                    senderPhone: userData.phoneNumber,
                    recipientId: recipientData.uid,
                    recipientName: recipientData.displayName,
                    recipientPhone: recipientData.phoneNumber,
                    amount: transferAmount,
                    type: 'transfer',
                    method: 'manual',
                    status: 'completed',
                    timestamp: window.firebaseServerTimestamp(),
                    createdAt: now.toISOString(),
                    description: `Transfer to ${recipientData.displayName}`
                };

                // Execute transfer in Firebase
                const updates = {};
                
                // Update sender balance
                updates[`users/${currentUser.uid}/balance`] = userData.balance - transferAmount;
                
                // Update recipient balance
                const recipientRef = window.firebaseRef(window.firebaseDatabase, `users/${recipientData.uid}`);
                const recipientSnapshot = await window.firebaseGet(recipientRef);
                const recipientData_full = recipientSnapshot.val();
                updates[`users/${recipientData.uid}/balance`] = (recipientData_full.balance || 0) + transferAmount;
                
                // Add transaction record
                updates[`transactions/${transactionId}`] = transactionData;
                
                // Add to user transaction history
                updates[`userTransactions/${currentUser.uid}/${transactionId}`] = {
                    ...transactionData,
                    direction: 'outgoing'
                };
                updates[`userTransactions/${recipientData.uid}/${transactionId}`] = {
                    ...transactionData,
                    direction: 'incoming'
                };

                // Update monthly expenses for sender
                const currentMonth = now.toISOString().slice(0, 7); // YYYY-MM
                updates[`users/${currentUser.uid}/monthlyExpense`] = (userData.monthlyExpense || 0) + transferAmount;
                
                // Update monthly income for recipient
                updates[`users/${recipientData.uid}/monthlyIncome`] = (recipientData_full.monthlyIncome || 0) + transferAmount;

                // Execute all updates atomically
                await window.firebaseUpdate(window.firebaseRef(window.firebaseDatabase), updates);

                // Update local balance
                userBalance = userData.balance - transferAmount;
                updateBalanceDisplay();

                // Show success screen with transaction details
                document.getElementById("finalRecipientName").textContent = recipientData.displayName;
                document.getElementById("finalRecipientPhone").textContent = recipientData.phoneNumber;
                document.getElementById("finalTransferAmount").textContent = formatCurrency(transferAmount);
                document.getElementById("finalTransferDate").textContent = now.toLocaleDateString("id-ID");
                document.getElementById("finalTransferTime").textContent = now.toLocaleTimeString("id-ID");
                document.getElementById("finalOrderId").textContent = transactionId;

                showMessage("Transfer berhasil!", "success");
                showTransferStep(4);

                // Refresh transaction history
                loadRecentTransactions();

            } catch (error) {
                console.error("Error executing transfer:", error);
                showMessage("Terjadi kesalahan saat memproses transfer.", "error");
            }
        }

        function resetTransfer() {
            document.getElementById("recipientPhone").value = "";
            document.getElementById("transferAmount").value = "";
            recipientData = null;
            transferAmount = 0;
            showTransferStep(1);
        }

        function shareReceipt() {
            showMessage("Fitur berbagi bukti transfer akan segera tersedia.", "info");
        }

        // QR Code functions
        function showQROptions() {
            showModal("QR Pay", `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="quick-action" onclick="startQRScanner()" style="margin: 0;">
                        <i class="fas fa-camera"></i>
                        <div>Scan QR Code</div>
                    </div>
                    <div class="quick-action" onclick="showMyQRCode()" style="margin: 0;">
                        <i class="fas fa-qrcode"></i>
                        <div>QR Code Saya</div>
                    </div>
                </div>
            `);
        }

        async function startQRScanner() {
            closeModal();
            showModal("Scan QR Code", `
                <div class="qr-scanner-container">
                    <div id="qrScannerPreview" style="width: 300px; height: 300px; background: #000; border-radius: 16px; position: relative; display: flex; align-items: center; justify-content: center; color: white;">
                        <div style="text-align: center;">
                            <i class="fas fa-camera" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p style="opacity: 0.7;">Simulasi Kamera QR Scanner</p>
                            <div id="scanningIndicator" style="margin-top: 1rem;">
                                <div class="loading" style="margin: 0 auto;"></div>
                                <p style="margin-top: 0.5rem; font-size: 0.9rem;">Scanning...</p>
                            </div>
                        </div>
                    </div>
                    <div class="qr-overlay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 2px solid var(--primary-color); border-radius: 16px; pointer-events: none;"></div>
                </div>
                <p style="text-align: center; margin-top: 1rem;">Arahkan kamera ke QR Code untuk transfer</p>
                <div style="margin-top: 1rem; text-align: center;">
                    <button class="btn btn-secondary" onclick="stopQRScanner()">Stop Scan</button>
                    <button class="btn btn-primary" onclick="simulateQRDetection()" style="margin-left: 0.5rem;">Simulasi QR Terdeteksi</button>
                </div>
            `);

            // Simulate scanning process
            setTimeout(() => {
                const indicator = document.getElementById('scanningIndicator');
                if (indicator) {
                    indicator.innerHTML = `
                        <i class="fas fa-search" style="color: var(--primary-color); font-size: 1.5rem;"></i>
                        <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--primary-color);">Mencari QR Code...</p>
                    `;
                }
            }, 2000);
        }

        function simulateQRDetection() {
            // Simulate QR code detection with a sample phone number
            const samplePhoneNumbers = ['+62812345678', '+62821234567', '+62831234567', '+62851234567'];
            const randomPhone = samplePhoneNumbers[Math.floor(Math.random() * samplePhoneNumbers.length)];
            
            showMessage("QR Code terdeteksi! Mengarahkan ke transfer...", "success");
            stopQRScanner();
            
            // Auto-fill the transfer form
            document.getElementById("recipientPhone").value = randomPhone;
            showSection("transfer");
            
            // Auto-search recipient after a short delay
            setTimeout(() => {
                searchRecipient();
            }, 500);
        }

        function stopQRScanner() {
            closeModal();
        }

        async function showMyQRCode() {
            const userPhone = document.getElementById("userPhone").textContent;
            const userName = document.getElementById("userFullName").textContent;
            
            showModal("QR Code Saya", `
                <div class="qr-container">
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--primary-gradient); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: 700;">
                            ${userName[0].toUpperCase()}
                        </div>
                        <h3 style="margin: 0; color: var(--text-primary);">${userName}</h3>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">${userPhone}</p>
                    </div>
                    <div class="qr-code-display">
                        <canvas id="myQRCodeCanvas" style="border: 1px solid var(--border-color); border-radius: 12px;"></canvas>
                    </div>
                    <p style="text-align: center; color: var(--text-secondary); font-size: 0.9rem; margin-top: 1rem;">
                        Scan QR Code ini untuk transfer ke akun Anda
                    </p>
                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button class="btn btn-primary" onclick="shareQRCode()">Bagikan QR Code</button>
                        <button class="btn btn-secondary" onclick="downloadQRCode()">Download</button>
                    </div>
                </div>
            `);

            // Generate QR Code with user phone number
            const canvas = document.getElementById("myQRCodeCanvas");
            if (typeof QRCode !== 'undefined') {
                try {
                    await QRCode.toCanvas(canvas, userPhone, {
                        width: 200,
                        height: 200,
                        color: {
                            dark: '#2c3e50',
                            light: '#ffffff'
                        },
                        margin: 2
                    });
                    console.log("QR Code generated successfully!");
                } catch (error) {
                    console.error("Error generating QR Code:", error);
                    canvas.style.display = 'none';
                    canvas.parentNode.innerHTML = `
                        <div style="width: 200px; height: 200px; border: 2px dashed var(--border-color); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                            <div style="text-align: center; color: var(--text-muted);">
                                <i class="fas fa-qrcode" style="font-size: 3rem; margin-bottom: 0.5rem;"></i>
                                <p>QR Code Preview</p>
                                <p style="font-size: 0.8rem;">${userPhone}</p>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Fallback if QRCode library is not available
                canvas.style.display = 'none';
                canvas.parentNode.innerHTML = `
                    <div style="width: 200px; height: 200px; border: 2px dashed var(--border-color); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                        <div style="text-align: center; color: var(--text-muted);">
                            <i class="fas fa-qrcode" style="font-size: 3rem; margin-bottom: 0.5rem;"></i>
                            <p>QR Code Preview</p>
                            <p style="font-size: 0.8rem;">${userPhone}</p>
                        </div>
                    </div>
                `;
            }
        }

        function shareQRCode() {
            if (navigator.share) {
                navigator.share({
                    title: 'QR Code PremiumBank',
                    text: `Scan QR Code ini untuk transfer ke ${document.getElementById("userFullName").textContent}`,
                    url: window.location.href
                }).catch(console.error);
            } else {
                // Fallback for browsers that don't support Web Share API
                const userPhone = document.getElementById("userPhone").textContent;
                const userName = document.getElementById("userFullName").textContent;
                const shareText = `Scan QR Code ini untuk transfer ke ${userName} (${userPhone})`;
                
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(shareText).then(() => {
                        showMessage("Link QR Code disalin ke clipboard!", "success");
                    });
                } else {
                    showMessage("Fitur berbagi tidak didukung di browser ini.", "info");
                }
            }
        }

        function downloadQRCode() {
            const canvas = document.getElementById("myQRCodeCanvas");
            if (canvas) {
                const link = document.createElement('a');
                link.download = `qr-code-${document.getElementById("userPhone").textContent.replace(/\+/g, '')}.png`;
                link.href = canvas.toDataURL();
                link.click();
                showMessage("QR Code berhasil didownload!", "success");
            } else {
                showMessage("QR Code tidak tersedia untuk didownload.", "error");
            }
        }

        // Top Up functions
        function showTopUpForm(method) {
            let title = "";
            let content = "";
            
            switch(method) {
                case 'bank':
                    title = "Top Up via Transfer Bank";
                    content = `
                        <div class="form-group">
                            <label class="form-label">Jumlah Top Up</label>
                            <input type="number" class="form-input" id="topupAmount" placeholder="Minimum Rp 10,000" min="10000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pilih Bank</label>
                            <select class="form-select" id="bankSelect">
                                <option value="bca">BCA</option>
                                <option value="mandiri">Mandiri</option>
                                <option value="bni">BNI</option>
                                <option value="bri">BRI</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="processTopUp('bank')">Lanjutkan</button>
                    `;
                    break;
                case 'ewallet':
                    title = "Top Up via E-Wallet";
                    content = `
                        <div class="form-group">
                            <label class="form-label">Jumlah Top Up</label>
                            <input type="number" class="form-input" id="topupAmount" placeholder="Minimum Rp 10,000" min="10000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pilih E-Wallet</label>
                            <select class="form-select" id="ewalletSelect">
                                <option value="gopay">GoPay</option>
                                <option value="ovo">OVO</option>
                                <option value="dana">DANA</option>
                                <option value="linkaja">LinkAja</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="processTopUp('ewallet')">Lanjutkan</button>
                    `;
                    break;
                case 'card':
                    title = "Top Up via Kartu";
                    content = `
                        <div class="form-group">
                            <label class="form-label">Jumlah Top Up</label>
                            <input type="number" class="form-input" id="topupAmount" placeholder="Minimum Rp 10,000" min="10000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nomor Kartu</label>
                            <input type="text" class="form-input" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Expired</label>
                                <input type="text" class="form-input" id="cardExpiry" placeholder="MM/YY" maxlength="5">
                            </div>
                            <div class="form-group">
                                <label class="form-label">CVV</label>
                                <input type="text" class="form-input" id="cardCvv" placeholder="123" maxlength="3">
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="processTopUp('card')">Lanjutkan</button>
                    `;
                    break;
            }
            
            showModal(title, content);
        }

        async function processTopUp(method) {
            const amount = parseInt(document.getElementById("topupAmount").value);
            if (isNaN(amount) || amount < 10000) {
                showMessage("Minimum top up Rp 10,000", "warning");
                return;
            }

            let paymentMethod = '';
            let paymentDetails = {};

            // Get payment method details
            switch(method) {
                case 'bank':
                    const selectedBank = document.getElementById("bankSelect").value;
                    paymentMethod = `Transfer Bank ${selectedBank.toUpperCase()}`;
                    paymentDetails = { bank: selectedBank };
                    break;
                case 'ewallet':
                    const selectedEwallet = document.getElementById("ewalletSelect").value;
                    paymentMethod = `E-Wallet ${selectedEwallet.toUpperCase()}`;
                    paymentDetails = { ewallet: selectedEwallet };
                    break;
                case 'card':
                    const cardNumber = document.getElementById("cardNumber").value;
                    const cardExpiry = document.getElementById("cardExpiry").value;
                    const cardCvv = document.getElementById("cardCvv").value;
                    
                    if (!cardNumber || !cardExpiry || !cardCvv) {
                        showMessage("Lengkapi semua data kartu", "warning");
                        return;
                    }
                    
                    paymentMethod = `Kartu Kredit/Debit`;
                    paymentDetails = { 
                        cardNumber: cardNumber.replace(/\s/g, '').slice(-4), // Only store last 4 digits
                        expiry: cardExpiry 
                    };
                    break;
            }

            closeModal();
            showMessage("Memproses top up...", "info");
            
            try {
                // Get current user data
                const userRef = window.firebaseRef(window.firebaseDatabase, `users/${currentUser.uid}`);
                const userSnapshot = await window.firebaseGet(userRef);
                
                if (!userSnapshot.exists()) {
                    showMessage("Data pengguna tidak ditemukan.", "error");
                    return;
                }

                const userData = userSnapshot.val();

                // Generate transaction ID
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                const timeStr = now.getTime().toString().slice(-3);
                const transactionId = `TXN-${dateStr}-${timeStr}`;

                // Prepare transaction data
                const transactionData = {
                    id: transactionId,
                    userId: currentUser.uid,
                    userName: userData.displayName || currentUser.email.split('@')[0],
                    userPhone: userData.phoneNumber,
                    amount: amount,
                    type: 'topup',
                    method: method,
                    paymentMethod: paymentMethod,
                    paymentDetails: paymentDetails,
                    status: 'completed',
                    timestamp: window.firebaseServerTimestamp(),
                    createdAt: now.toISOString(),
                    description: `Top Up via ${paymentMethod}`
                };

                // Prepare updates
                const updates = {};
                
                // Update user balance
                updates[`users/${currentUser.uid}/balance`] = userData.balance + amount;
                
                // Update monthly income
                updates[`users/${currentUser.uid}/monthlyIncome`] = (userData.monthlyIncome || 0) + amount;
                
                // Add transaction record
                updates[`transactions/${transactionId}`] = transactionData;
                
                // Add to user transaction history
                updates[`userTransactions/${currentUser.uid}/${transactionId}`] = {
                    ...transactionData,
                    direction: 'incoming'
                };

                // Execute all updates atomically
                await window.firebaseUpdate(window.firebaseRef(window.firebaseDatabase), updates);

                // Update local balance
                userBalance = userData.balance + amount;
                updateBalanceDisplay();

                // Update monthly income display
                document.getElementById('monthlyIncome').textContent = formatCurrency((userData.monthlyIncome || 0) + amount);

                // Refresh transaction history
                loadRecentTransactions();

                showMessage(`Top up berhasil! Saldo bertambah ${formatCurrency(amount)}`, "success");

            } catch (error) {
                console.error("Error processing top up:", error);
                showMessage("Terjadi kesalahan saat memproses top up.", "error");
            }
        }

        // Bills functions
        function showBillForm(type) {
            let title = "";
            let content = "";
            
            switch(type) {
                case 'electricity':
                    title = "Bayar Listrik PLN";
                    content = `
                        <div class="form-group">
                            <label class="form-label">ID Pelanggan</label>
                            <input type="text" class="form-input" id="customerId" placeholder="Masukkan ID Pelanggan PLN">
                        </div>
                        <button class="btn btn-primary" onclick="checkBill('electricity')">Cek Tagihan</button>
                    `;
                    break;
                case 'water':
                    title = "Bayar Air PDAM";
                    content = `
                        <div class="form-group">
                            <label class="form-label">ID Pelanggan</label>
                            <input type="text" class="form-input" id="customerId" placeholder="Masukkan ID Pelanggan PDAM">
                        </div>
                        <button class="btn btn-primary" onclick="checkBill('water')">Cek Tagihan</button>
                    `;
                    break;
                case 'phone':
                    title = "Beli Pulsa & Paket Data";
                    content = `
                        <div class="form-group">
                            <label class="form-label">Nomor Telepon</label>
                            <input type="tel" class="form-input" id="phoneNumber" placeholder="+62812345678">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Provider</label>
                            <select class="form-select" id="provider">
                                <option value="telkomsel">Telkomsel</option>
                                <option value="xl">XL</option>
                                <option value="indosat">Indosat</option>
                                <option value="tri">3 (Tri)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nominal</label>
                            <select class="form-select" id="phoneCredit">
                                <option value="10000">Rp 10,000</option>
                                <option value="25000">Rp 25,000</option>
                                <option value="50000">Rp 50,000</option>
                                <option value="100000">Rp 100,000</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="processBillPayment('phone')">Beli Sekarang</button>
                    `;
                    break;
                default:
                    title = "Pembayaran Tagihan";
                    content = `
                        <div style="text-align: center; padding: 2rem;">
                            <i class="fas fa-tools" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
                            <p>Fitur pembayaran ${type} sedang dalam pengembangan.</p>
                            <button class="btn btn-primary" onclick="closeModal()">OK</button>
                        </div>
                    `;
                    break;
            }
            
            showModal(title, content);
        }

        async function checkBill(type) {
            const customerId = document.getElementById("customerId").value.trim();
            if (!customerId) {
                showMessage("Masukkan ID Pelanggan", "warning");
                return;
            }

            showMessage("Mengecek tagihan...", "info");

            try {
                // Simulate bill check with realistic data
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const billData = generateBillData(type, customerId);
                
                showModal("Detail Tagihan", `
                    <div class="form-group">
                        <label class="form-label">ID Pelanggan</label>
                        <input type="text" class="form-input" value="${customerId}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nama Pelanggan</label>
                        <input type="text" class="form-input" value="${billData.customerName}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Periode Tagihan</label>
                        <input type="text" class="form-input" value="${billData.period}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Jumlah Tagihan</label>
                        <input type="text" class="form-input" value="${formatCurrency(billData.amount)}" readonly style="font-weight: 600; color: var(--danger-color);">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Jatuh Tempo</label>
                        <input type="text" class="form-input" value="${billData.dueDate}" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <input type="text" class="form-input" value="${billData.status}" readonly style="color: ${billData.status === 'Belum Dibayar' ? 'var(--danger-color)' : 'var(--secondary-color)'};">
                    </div>
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="processBillPayment('${type}', ${billData.amount}, '${customerId}', '${billData.customerName}')">Bayar Sekarang</button>
                        <button class="btn btn-secondary" onclick="closeModal()">Batal</button>
                    </div>
                `);
                
            } catch (error) {
                console.error("Error checking bill:", error);
                showMessage("Terjadi kesalahan saat mengecek tagihan.", "error");
            }
        }

        function generateBillData(type, customerId) {
            const customerNames = ['John Doe', 'Jane Smith', 'Ahmad Wijaya', 'Siti Nurhaliza', 'Budi Santoso'];
            const randomName = customerNames[Math.floor(Math.random() * customerNames.length)];
            
            let billData = {
                customerName: randomName,
                period: getCurrentPeriod(),
                status: 'Belum Dibayar'
            };

            switch(type) {
                case 'electricity':
                    billData.amount = Math.floor(Math.random() * 500000) + 100000; // 100k - 600k
                    billData.dueDate = getRandomDueDate();
                    break;
                case 'water':
                    billData.amount = Math.floor(Math.random() * 200000) + 50000; // 50k - 250k
                    billData.dueDate = getRandomDueDate();
                    break;
                case 'internet':
                    billData.amount = Math.floor(Math.random() * 300000) + 200000; // 200k - 500k
                    billData.dueDate = getRandomDueDate();
                    break;
                default:
                    billData.amount = Math.floor(Math.random() * 300000) + 100000;
                    billData.dueDate = getRandomDueDate();
                    break;
            }

            return billData;
        }

        function getCurrentPeriod() {
            const now = new Date();
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                          'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            return `${months[now.getMonth()]} ${now.getFullYear()}`;
        }

        function getRandomDueDate() {
            const now = new Date();
            const daysToAdd = Math.floor(Math.random() * 15) + 1; // 1-15 days from now
            const dueDate = new Date(now.getTime() + (daysToAdd * 24 * 60 * 60 * 1000));
            return dueDate.toLocaleDateString('id-ID');
        }

        async function processBillPayment(type, amount, customerId, customerName) {
            if (type === 'phone') {
                amount = parseInt(document.getElementById("phoneCredit").value);
                const phoneNumber = document.getElementById("phoneNumber").value;
                const provider = document.getElementById("provider").value;
                
                if (!phoneNumber) {
                    showMessage("Masukkan nomor telepon", "warning");
                    return;
                }
                
                customerId = phoneNumber;
                customerName = `Pulsa ${provider.toUpperCase()}`;
            }
            
            if (userBalance < amount) {
                showMessage("Saldo tidak mencukupi", "error");
                return;
            }

            closeModal();
            showMessage("Memproses pembayaran...", "info");
            
            try {
                // Get current user data
                const userRef = window.firebaseRef(window.firebaseDatabase, `users/${currentUser.uid}`);
                const userSnapshot = await window.firebaseGet(userRef);
                
                if (!userSnapshot.exists()) {
                    showMessage("Data pengguna tidak ditemukan.", "error");
                    return;
                }

                const userData = userSnapshot.val();

                // Generate transaction ID
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                const timeStr = now.getTime().toString().slice(-3);
                const transactionId = `TXN-${dateStr}-${timeStr}`;

                // Prepare transaction data
                const transactionData = {
                    id: transactionId,
                    userId: currentUser.uid,
                    userName: userData.displayName || currentUser.email.split('@')[0],
                    userPhone: userData.phoneNumber,
                    amount: amount,
                    type: 'bill',
                    billType: type,
                    customerId: customerId,
                    customerName: customerName,
                    status: 'completed',
                    timestamp: window.firebaseServerTimestamp(),
                    createdAt: now.toISOString(),
                    description: `Pembayaran ${getBillTypeName(type)} - ${customerName}`
                };

                // Prepare updates
                const updates = {};
                
                // Update user balance
                updates[`users/${currentUser.uid}/balance`] = userData.balance - amount;
                
                // Update monthly expense
                updates[`users/${currentUser.uid}/monthlyExpense`] = (userData.monthlyExpense || 0) + amount;
                
                // Add transaction record
                updates[`transactions/${transactionId}`] = transactionData;
                
                // Add to user transaction history
                updates[`userTransactions/${currentUser.uid}/${transactionId}`] = {
                    ...transactionData,
                    direction: 'outgoing'
                };

                // Save bill payment record
                updates[`bills/${currentUser.uid}/${transactionId}`] = {
                    billType: type,
                    customerId: customerId,
                    customerName: customerName,
                    amount: amount,
                    paidAt: now.toISOString(),
                    transactionId: transactionId
                };

                // Execute all updates atomically
                await window.firebaseUpdate(window.firebaseRef(window.firebaseDatabase), updates);

                // Update local balance
                userBalance = userData.balance - amount;
                updateBalanceDisplay();

                // Update monthly expense display
                document.getElementById('monthlyExpense').textContent = formatCurrency((userData.monthlyExpense || 0) + amount);

                // Refresh transaction history
                loadRecentTransactions();

                showMessage(`Pembayaran berhasil! ${formatCurrency(amount)} telah dibayarkan untuk ${getBillTypeName(type)}.`, "success");

            } catch (error) {
                console.error("Error processing bill payment:", error);
                showMessage("Terjadi kesalahan saat memproses pembayaran.", "error");
            }
        }

        function getBillTypeName(type) {
            const billTypes = {
                'electricity': 'Listrik PLN',
                'water': 'Air PDAM',
                'internet': 'Internet & TV',
                'phone': 'Pulsa & Paket Data',
                'insurance': 'Asuransi',
                'tax': 'Pajak'
            };
            return billTypes[type] || 'Tagihan';
        }

        // Investment functions
        function investMore(type) {
            showModal("Investasi Tambahan", `
                <div class="form-group">
                    <label class="form-label">Jumlah Investasi</label>
                    <input type="number" class="form-i        async function processInvestment(type, amount) {
            if (userBalance < amount) {
                showMessage("Saldo tidak mencukupi untuk investasi", "error");
                return;
            }

            closeModal();
            showMessage("Memproses investasi...", "info");
            
            try {
                // Get current user data
                const userRef = window.firebaseRef(window.firebaseDatabase, `users/${currentUser.uid}`);
                const userSnapshot = await window.firebaseGet(userRef);
                
                if (!userSnapshot.exists()) {
                    showMessage("Data pengguna tidak ditemukan.", "error");
                    return;
                }

                const userData = userSnapshot.val();

                // Generate transaction and investment IDs
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                const timeStr = now.getTime().toString().slice(-3);
                const transactionId = `TXN-${dateStr}-${timeStr}`;
                const investmentId = `INV-${dateStr}-${timeStr}`;

                // Get investment details
                const investmentDetails = getInvestmentDetails(type, amount);

                // Prepare transaction data
                const transactionData = {
                    id: transactionId,
                    userId: currentUser.uid,
                    userName: userData.displayName || currentUser.email.split('@')[0],
                    userPhone: userData.phoneNumber,
                    amount: amount,
                    type: 'investment',
                    investmentType: type,
                    investmentId: investmentId,
                    status: 'completed',
                    timestamp: window.firebaseServerTimestamp(),
                    createdAt: now.toISOString(),
                    description: `Investasi ${investmentDetails.name}`
                };

                // Prepare investment data
                const investmentData = {
                    id: investmentId,
                    type: type,
                    name: investmentDetails.name,
                    amount: amount,
                    units: investmentDetails.units,
                    pricePerUnit: investmentDetails.pricePerUnit,
                    purchaseDate: now.toISOString(),
                    currentValue: amount, // Initially same as purchase amount
                    returnPercentage: 0,
                    status: 'active',
                    transactionId: transactionId
                };

                // Prepare updates
                const updates = {};
                
                // Update user balance
                updates[`users/${currentUser.uid}/balance`] = userData.balance - amount;
                
                // Update monthly expense
                updates[`users/${currentUser.uid}/monthlyExpense`] = (userData.monthlyExpense || 0) + amount;
                
                // Add transaction record
                updates[`transactions/${transactionId}`] = transactionData;
                
                // Add to user transaction history
                updates[`userTransactions/${currentUser.uid}/${transactionId}`] = {
                    ...transactionData,
                    direction: 'outgoing'
                };

                // Add investment record
                updates[`investments/${currentUser.uid}/${investmentId}`] = investmentData;

                // Execute all updates atomically
                await window.firebaseUpdate(window.firebaseRef(window.firebaseDatabase), updates);

                // Update local balance
                userBalance = userData.balance - amount;
                updateBalanceDisplay();

                // Update monthly expense display
                document.getElementById('monthlyExpense').textContent = formatCurrency((userData.monthlyExpense || 0) + amount);

                // Refresh transaction history and investments
                loadRecentTransactions();
                loadInvestments();

                showMessage(`Investasi berhasil! ${formatCurrency(amount)} telah diinvestasikan ke ${investmentDetails.name}.`, "success");

            } catch (error) {
                console.error("Error processing investment:", error);
                showMessage("Terjadi kesalahan saat memproses investasi.", "error");
            }
        }

        function getInvestmentDetails(type, amount) {
            const investmentTypes = {
                'mutual_fund': {
                    name: 'Reksa Dana Saham',
                    pricePerUnit: 1000,
                    riskLevel: 'Menengah-Tinggi',
                    expectedReturn: '8-12% per tahun'
                },
                'gold': {
                    name: 'Emas Digital',
                    pricePerUnit: 1000000, // per gram
                    riskLevel: 'Rendah-Menengah',
                    expectedReturn: '5-8% per tahun'
                },
                'bonds': {
                    name: 'Obligasi Pemerintah',
                    pricePerUnit: 1000000,
                    riskLevel: 'Rendah',
                    expectedReturn: '6-8% per tahun'
                },
                'crypto': {
                    name: 'Cryptocurrency',
                    pricePerUnit: 100000,
                    riskLevel: 'Tinggi',
                    expectedReturn: '10-30% per tahun (volatil)'
                }
            };

            const details = investmentTypes[type] || investmentTypes['mutual_fund'];
            const units = amount / details.pricePerUnit;

            return {
                ...details,
                units: parseFloat(units.toFixed(6))
            };
        }

        async function loadInvestments() {
            if (!currentUser) return;
            
            try {
                const investmentsRef = window.firebaseRef(window.firebaseDatabase, `investments/${currentUser.uid}`);
                const snapshot = await window.firebaseGet(investmentsRef);
                
                const investmentsContainer = document.getElementById('investmentsList');
                
                if (snapshot.exists()) {
                    const investments = snapshot.val();
                    const investmentArray = Object.values(investments).sort((a, b) => 
                        new Date(b.purchaseDate) - new Date(a.purchaseDate)
                    );
                    
                    investmentsContainer.innerHTML = '';
                    
                    let totalInvestmentValue = 0;
                    
                    investmentArray.forEach(investment => {
                        // Simulate market fluctuation for current value
                        const fluctuation = (Math.random() - 0.5) * 0.2; // 10% fluctuation
                        const currentValue = investment.amount * (1 + fluctuation);
                        const returnPercentage = ((currentValue - investment.amount) / investment.amount) * 100;
                        
                        totalInvestmentValue += currentValue;
                        
                        const investmentElement = createInvestmentElement(investment, currentValue, returnPercentage);
                        investmentsContainer.appendChild(investmentElement);
                    });
                    
                    // Update total investment value display
                    const totalInvestmentElement = document.getElementById('totalInvestmentValue');
                    if (totalInvestmentElement) {
                        totalInvestmentElement.textContent = formatCurrency(totalInvestmentValue);
                    }
                } else {
                    investmentsContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <i class="fas fa-chart-line" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Belum ada investasi</p>
                            <button class="btn btn-primary" onclick="showSection('invest')">Mulai Investasi</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading investments:', error);
            }
        }

        function createInvestmentElement(investment, currentValue, returnPercentage) {
            const div = document.createElement('div');
            div.className = 'investment-item';
            
            const returnClass = returnPercentage >= 0 ? 'profit' : 'loss';
            const returnPrefix = returnPercentage >= 0 ? '+' : '';
            
            div.innerHTML = `
                <div class="investment-header">
                    <div class="investment-icon">
                        <i class="${getInvestmentIcon(investment.type)}"></i>
                    </div>
                    <div class="investment-details">
                        <div class="investment-name">${investment.name}</div>
                        <div class="investment-units">${investment.units} unit</div>
                    </div>
                    <div class="investment-value">
                        <div class="current-value">${formatCurrency(currentValue)}</div>
                        <div class="return-percentage ${returnClass}">${returnPrefix}${returnPercentage.toFixed(2)}%</div>
                    </div>
                </div>
                <div class="investment-footer">
                    <span>Dibeli: ${new Date(investment.purchaseDate).toLocaleDateString('id-ID')}</span>
                    <span>Modal: ${formatCurrency(investment.amount)}</span>
                </div>
            `;
            
            return div;
        }

        function getInvestmentIcon(type) {
            const icons = {
                'mutual_fund': 'fas fa-chart-pie',
                'gold': 'fas fa-coins',
                'bonds': 'fas fa-university',
                'crypto': 'fab fa-bitcoin'
            };
            return icons[type] || 'fas fa-chart-line';
        }

        function investMore(type) {
            const investmentDetails = getInvestmentDetails(type, 100000); // Sample amount for details
            
            showModal(`Investasi ${investmentDetails.name}`, `
                <div class="investment-info">
                    <div class="info-item">
                        <label>Jenis Investasi:</label>
                        <span>${investmentDetails.name}</span>
                    </div>
                    <div class="info-item">
                        <label>Tingkat Risiko:</label>
                        <span>${investmentDetails.riskLevel}</span>
                    </div>
                    <div class="info-item">
                        <label>Perkiraan Return:</label>
                        <span>${investmentDetails.expectedReturn}</span>
                    </div>
                    <div class="info-item">
                        <label>Harga per Unit:</label>
                        <span>${formatCurrency(investmentDetails.pricePerUnit)}</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Jumlah Investasi</label>
                    <input type="number" id="investmentAmount" class="form-input" placeholder="Minimum Rp 100,000" min="100000" step="50000">
                </div>
                <div style="margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="confirmInvestment('${type}')">Investasi Sekarang</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Batal</button>
                </div>
            `);
        }

        function confirmInvestment(type) {
            const amount = parseInt(document.getElementById("investmentAmount").value);
            if (isNaN(amount) || amount < 100000) {
                showMessage("Minimum investasi Rp 100,000", "warning");
                return;
            }

            processInvestment(type, amount);
        }     function viewInvestmentDetail(type) {
            showModal("Detail Investasi", `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-chart-line" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 1rem;"></i>
                    <p>Detail investasi ${type} akan ditampilkan di sini.</p>
                    <button class="btn btn-primary" onclick="closeModal()">OK</button>
                </div>
            `);
        }

        function startNewInvestment(type) {
            investMore(type);
        }

        // Card functions
        function showCardAction(action) {
            let title = "";
            let content = "";
            
            switch(action) {
                case 'block':
                    title = "Blokir Kartu";
                    content = `
                        <div style="text-align: center; padding: 2rem;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--danger-color); margin-bottom: 1rem;"></i>
                            <p>Apakah Anda yakin ingin memblokir kartu ini?</p>
                            <p style="color: var(--text-secondary); font-size: 0.9rem;">Kartu yang diblokir tidak dapat digunakan untuk transaksi.</p>
                            <div style="margin-top: 2rem;">
                                <button class="btn btn-danger" onclick="processCardAction('block')">Ya, Blokir Kartu</button>
                                <button class="btn btn-secondary" onclick="closeModal()">Batal</button>
                            </div>
                        </div>
                    `;
                    break;
                case 'limit':
                    title = "Atur Limit Kartu";
                    content = `
                        <div class="form-group">
                            <label class="form-label">Limit Harian ATM</label>
                            <input type="number" class="form-input" id="atmLimit" value="5000000" placeholder="Rp 5,000,000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Limit Harian Debit</label>
                            <input type="number" class="form-input" id="debitLimit" value="10000000" placeholder="Rp 10,000,000">
                        </div>
                        <button class="btn btn-primary" onclick="processCardAction('limit')">Simpan Perubahan</button>
                    `;
                    break;
                case 'pin':
                    title = "Ganti PIN Kartu";
                    content = `
                        <div class="form-group">
                            <label class="form-label">PIN Lama</label>
                            <input type="password" class="form-input" id="oldPin" maxlength="6" placeholder="Masukkan PIN lama">
                        </div>
                        <div class="form-group">
                            <label class="form-label">PIN Baru</label>
                            <input type="password" class="form-input" id="newPin" maxlength="6" placeholder="Masukkan PIN baru">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Konfirmasi PIN Baru</label>
                            <input type="password" class="form-input" id="confirmPin" maxlength="6" placeholder="Konfirmasi PIN baru">
                        </div>
                        <button class="btn btn-primary" onclick="processCardAction('pin')">Ganti PIN</button>
                    `;
                    break;
                default:
                    title = "Fitur Kartu";
                    content = `
                        <div style="text-align: center; padding: 2rem;">
                            <i class="fas fa-tools" style="font-size: 3rem; color: var(--text-muted); margin-bottom: 1rem;"></i>
                            <p>Fitur ${action} sedang dalam pengembangan.</p>
                            <button class="btn btn-primary" onclick="closeModal()">OK</button>
                        </div>
                    `;
                    break;
            }
            
            showModal(title, content);
        }

        async function processCardAction(action, cardId) {
            showMessage("Memproses permintaan kartu...", "info");
            
            try {
                // Get current user data
                const userRef = window.firebaseRef(window.firebaseDatabase, `users/${currentUser.uid}`);
                const userSnapshot = await window.firebaseGet(userRef);
                
                if (!userSnapshot.exists()) {
                    showMessage("Data pengguna tidak ditemukan.", "error");
                    return;
                }

                const userData = userSnapshot.val();

                // Generate transaction ID for card actions
                const now = new Date();
                const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
                const timeStr = now.getTime().toString().slice(-3);
                const actionId = `CARD-${dateStr}-${timeStr}`;

                let actionData = {
                    id: actionId,
                    userId: currentUser.uid,
                    cardId: cardId,
                    action: action,
                    timestamp: window.firebaseServerTimestamp(),
                    createdAt: now.toISOString(),
                    status: 'completed'
                };

                let updates = {};
                let successMessage = '';

                switch(action) {
                    case 'block':
                        updates[`cards/${currentUser.uid}/${cardId}/status`] = 'blocked';
                        updates[`cards/${currentUser.uid}/${cardId}/blockedAt`] = now.toISOString();
                        successMessage = 'Kartu berhasil diblokir';
                        break;
                    
                    case 'unblock':
                        updates[`cards/${currentUser.uid}/${cardId}/status`] = 'active';
                        updates[`cards/${currentUser.uid}/${cardId}/unblockedAt`] = now.toISOString();
                        successMessage = 'Kartu berhasil dibuka blokir';
                        break;
                    
                    case 'set_limit':
                        const newLimit = parseInt(document.getElementById("newLimit").value);
                        if (isNaN(newLimit) || newLimit < 100000) {
                            showMessage("Limit minimum Rp 100,000", "warning");
                            return;
                        }
                        updates[`cards/${currentUser.uid}/${cardId}/dailyLimit`] = newLimit;
                        updates[`cards/${currentUser.uid}/${cardId}/limitUpdatedAt`] = now.toISOString();
                        actionData.newLimit = newLimit;
                        successMessage = `Limit harian berhasil diubah menjadi ${formatCurrency(newLimit)}`;
                        break;
                    
                    case 'change_pin':
                        const newPin = document.getElementById("newCardPin").value;
                        const confirmPin = document.getElementById("confirmCardPin").value;
                        
                        if (newPin !== confirmPin) {
                            showMessage("PIN tidak cocok", "warning");
                            return;
                        }
                        
                        if (newPin.length !== 6) {
                            showMessage("PIN harus 6 digit", "warning");
                            return;
                        }
                        
                        updates[`cards/${currentUser.uid}/${cardId}/pin`] = newPin; // In production, this should be hashed
                        updates[`cards/${currentUser.uid}/${cardId}/pinChangedAt`] = now.toISOString();
                        successMessage = 'PIN kartu berhasil diubah';
                        break;
                    
                    case 'request_new':
                        const cardType = document.getElementById("cardType").value;
                        const newCardId = `CARD-${dateStr}-${timeStr}`;
                        
                        const newCardData = {
                            id: newCardId,
                            type: cardType,
                            number: generateCardNumber(),
                            holderName: userData.displayName || currentUser.email.split('@')[0],
                            expiryDate: getCardExpiryDate(),
                            status: 'active',
                            dailyLimit: cardType === 'credit' ? 5000000 : 2000000,
                            pin: '123456', // Default PIN
                            createdAt: now.toISOString(),
                            issuedBy: 'PremiumBank'
                        };
                        
                        updates[`cards/${currentUser.uid}/${newCardId}`] = newCardData;
                        actionData.newCardId = newCardId;
                        actionData.cardType = cardType;
                        successMessage = `Kartu ${cardType} baru berhasil diterbitkan`;
                        break;
                }

                // Save action record
                updates[`cardActions/${currentUser.uid}/${actionId}`] = actionData;

                // Execute all updates atomically
                await window.firebaseUpdate(window.firebaseRef(window.firebaseDatabase), updates);

                // Refresh cards display
                loadUserCards();

                closeModal();
                showMessage(successMessage, "success");

            } catch (error) {
                console.error("Error processing card action:", error);
                showMessage("Terjadi kesalahan saat memproses permintaan kartu.", "error");
            }
        }

        function generateCardNumber() {
            // Generate a realistic-looking card number (not real)
            const prefix = '4532'; // Visa-like prefix
            let number = prefix;
            
            for (let i = 0; i < 12; i++) {
                number += Math.floor(Math.random() * 10);
            }
            
            return number.replace(/(.{4})/g, '$1 ').trim();
        }

        function getCardExpiryDate() {
            const now = new Date();
            const expiryDate = new Date(now.getFullYear() + 3, now.getMonth(), 1);
            const month = String(expiryDate.getMonth() + 1).padStart(2, '0');
            const year = String(expiryDate.getFullYear()).slice(-2);
            return `${month}/${year}`;
        }

        async function loadUserCards() {
            if (!currentUser) return;
            
            try {
                const cardsRef = window.firebaseRef(window.firebaseDatabase, `cards/${currentUser.uid}`);
                const snapshot = await window.firebaseGet(cardsRef);
                
                const cardsContainer = document.getElementById('cardsList');
                
                if (snapshot.exists()) {
                    const cards = snapshot.val();
                    const cardArray = Object.values(cards).sort((a, b) => 
                        new Date(b.createdAt) - new Date(a.createdAt)
                    );
                    
                    cardsContainer.innerHTML = '';
                    
                    cardArray.forEach(card => {
                        const cardElement = createCardElement(card);
                        cardsContainer.appendChild(cardElement);
                    });
                } else {
                    cardsContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <i class="fas fa-credit-card" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Belum ada kartu</p>
                            <button class="btn btn-primary" onclick="requestNewCard()">Ajukan Kartu Baru</button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading user cards:', error);
            }
        }

        function createCardElement(card) {
            const div = document.createElement('div');
            div.className = 'card-item';
            
            const statusClass = card.status === 'active' ? 'active' : 'blocked';
            const statusText = card.status === 'active' ? 'Aktif' : 'Diblokir';
            
            div.innerHTML = `
                <div class="card-visual ${card.type}">
                    <div class="card-header">
                        <span class="card-type">${card.type.toUpperCase()}</span>
                        <span class="card-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="card-number">${card.number}</div>
                    <div class="card-footer">
                        <div class="card-holder">${card.holderName}</div>
                        <div class="card-expiry">${card.expiryDate}</div>
                    </div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-sm ${card.status === 'active' ? 'btn-danger' : 'btn-success'}" 
                            onclick="${card.status === 'active' ? `blockCard('${card.id}')` : `unblockCard('${card.id}')`}">
                        ${card.status === 'active' ? 'Blokir' : 'Buka Blokir'}
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="setCardLimit('${card.id}', ${card.dailyLimit})">
                        Atur Limit
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="changeCardPin('${card.id}')">
                        Ubah PIN
                    </button>
                </div>
                <div class="card-info">
                    <div class="info-item">
                        <span>Limit Harian:</span>
                        <span>${formatCurrency(card.dailyLimit)}</span>
                    </div>
                    <div class="info-item">
                        <span>Penerbit:</span>
                        <span>${card.issuedBy}</span>
                    </div>
                </div>
            `;
            
            return div;
        }

        function blockCard(cardId) {
            showModal("Konfirmasi Blokir Kartu", `
                <p>Apakah Anda yakin ingin memblokir kartu ini?</p>
                <p style="color: var(--warning-color); font-size: 0.9rem;">
                    Kartu yang diblokir tidak dapat digunakan untuk transaksi.
                </p>
                <div style="margin-top: 2rem;">
                    <button class="btn btn-danger" onclick="processCardAction('block', '${cardId}')">Ya, Blokir</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Batal</button>
                </div>
            `);
        }

        function unblockCard(cardId) {
            showModal("Konfirmasi Buka Blokir Kartu", `
                <p>Apakah Anda yakin ingin membuka blokir kartu ini?</p>
                <div style="margin-top: 2rem;">
                    <button class="btn btn-success" onclick="processCardAction('unblock', '${cardId}')">Ya, Buka Blokir</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Batal</button>
                </div>
            `);
        }

        function setCardLimit(cardId, currentLimit) {
            showModal("Atur Limit Harian", `
                <div class="form-group">
                    <label class="form-label">Limit Harian Saat Ini</label>
                    <input type="text" class="form-input" value="${formatCurrency(currentLimit)}" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Limit Harian Baru</label>
                    <input type="number" id="newLimit" class="form-input" placeholder="Minimum Rp 100,000" min="100000" step="100000" value="${currentLimit}">
                </div>
                <div style="margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="processCardAction('set_limit', '${cardId}')">Ubah Limit</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Batal</button>
                </div>
            `);
        }

        function changeCardPin(cardId) {
            showModal("Ubah PIN Kartu", `
                <div class="form-group">
                    <label class="form-label">PIN Baru (6 digit)</label>
                    <input type="password" id="newCardPin" class="form-input" maxlength="6" placeholder="Masukkan PIN baru">
                </div>
                <div class="form-group">
                    <label class="form-label">Konfirmasi PIN Baru</label>
                    <input type="password" id="confirmCardPin" class="form-input" maxlength="6" placeholder="Konfirmasi PIN baru">
                </div>
                <div style="margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="processCardAction('change_pin', '${cardId}')">Ubah PIN</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Batal</button>
                </div>
            `);
        }

        function requestNewCard() {
            showModal("Ajukan Kartu Baru", `
                <div class="form-group">
                    <label class="form-label">Jenis Kartu</label>
                    <select id="cardType" class="form-input">
                        <option value="debit">Kartu Debit</option>
                        <option value="credit">Kartu Kredit</option>
                    </select>
                </div>
                <div class="card-benefits">
                    <h4>Keuntungan Kartu PremiumBank:</h4>
                    <ul>
                        <li>Bebas biaya admin bulanan</li>
                        <li>Cashback hingga 5% untuk transaksi tertentu</li>
                        <li>Akses ke lounge bandara</li>
                        <li>Asuransi perjalanan gratis</li>
                        <li>Limit transaksi tinggi</li>
                    </ul>
                </div>
                <div style="margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="processCardAction('request_new', '')">Ajukan Kartu</button>
                    <button class="btn btn-secondary" onclick="closeModal()">Batal</button>
                </div>
            `);
        }

        // Support functions
        function contactSupport(method) {
            let message = "";
            switch(method) {
                case 'chat':
                    message = "Menghubungkan ke live chat...";
                    break;
                case 'phone':
                    message = "Call Center: 1500-123 (24/7)";
                    break;
                case 'email':
                    message = "Email: support@premiumbank.com";
                    break;
            }
            showMessage(message, "info");
        }

        function showFAQ() {
            showModal("Frequently Asked Questions", `
                <div style="text-align: left;">
                    <h4>Q: Bagaimana cara reset PIN transaksi?</h4>
                    <p>A: Anda dapat reset PIN melalui menu Settings > Security > Transaction PIN.</p>
                    
                    <h4>Q: Berapa limit transfer per hari?</h4>
                    <p>A: Limit transfer adalah Rp 25,000,000 per hari.</p>
                    
                    <h4>Q: Bagaimana cara menghubungi customer service?</h4>
                    <p>A: Anda dapat menghubungi kami melalui live chat, telepon 1500-123, atau email support@premiumbank.com.</p>
                </div>
            `);
        }

        // Settings functions
        function editProfile() {
            showModal('Edit Profile', `
                <form onsubmit="saveProfileEdit(event)">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-input" id="editFullName" value="${document.getElementById('userFullName').textContent}" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
        }

        function saveProfileEdit(event) {
            event.preventDefault();
            const newName = document.getElementById('editFullName').value;
            document.getElementById('userFullName').textContent = newName;
            document.getElementById('userGreeting').textContent = `Welcome back, ${newName}!`;
            showMessage('Profile updated successfully!', 'success');
            closeModal();
        }

        function editEmail() {
            showModal('Change Email Address', `
                <form onsubmit="saveNewEmail(event)">
                    <div class="form-group">
                        <label class="form-label">New Email</label>
                        <input type="email" class="form-input" id="newEmail" value="${document.getElementById('userEmail').textContent}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" class="form-input" id="currentPasswordEmail" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Change Email</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
        }

        function saveNewEmail(event) {
            event.preventDefault();
            const newEmail = document.getElementById('newEmail').value;
            document.getElementById('userEmail').textContent = newEmail;
            showMessage('Email address changed successfully!', 'success');
            closeModal();
        }

        function editPhone() {
            showModal('Change Phone Number', `
                <form onsubmit="saveNewPhone(event)">
                    <div class="form-group">
                        <label class="form-label">New Phone Number</label>
                        <input type="tel" class="form-input" id="newPhone" value="${document.getElementById('userPhone').textContent}" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Change Phone</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
        }

        function saveNewPhone(event) {
            event.preventDefault();
            const newPhone = document.getElementById('newPhone').value;
            document.getElementById('userPhone').textContent = newPhone;
            showMessage('Phone number updated successfully!', 'success');
            closeModal();
        }

        function changePassword() {
            showModal('Change Password', `
                <form onsubmit="saveNewPassword(event)">
                    <div class="form-group">
                        <label class="form-label">Current Password</label>
                        <input type="password" class="form-input" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-input" id="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-input" id="confirmNewPassword" required>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">Change Password</button>
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </form>
            `);
        }

        function saveNewPassword(event) {
            event.preventDefault();
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            if (newPassword !== confirmPassword) {
                showMessage('Passwords do not match!', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showMessage('Password must be at least 6 characters!', 'error');
                return;
            }

            showMessage('Password changed successfully!', 'success');
            closeModal();
        }

        function changePIN() {
            showModal('Change Transaction PIN', `
                <div class="form-group">
                    <label class="form-label">PIN Lama</label>
                    <div class="pin-input-container">
                        <input type="password" class="pin-digit" maxlength="1">
                        <input type="password" class="pin-digit" maxlength="1">
                        <input type="password" class="pin-digit" maxlength="1">
                        <input type="password" class="pin-digit" maxlength="1">
                        <input type="password" class="pin-digit" maxlength="1">
                        <input type="password" class="pin-digit" maxlength="1">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">PIN Baru</label>
                    <div class="pin-input-container">
                        <input type="password" class="pin-digit" maxlength="1">
                        <input type="password" class="pin-digit" maxlength="1">
                        <input type="password" class="pin-digit" maxlength="1">
                        <input type="password" class="pin-digit" maxlength="1">
                        <input type="password" class="pin-digit" maxlength="1">
                        <input type="password" class="pin-digit" maxlength="1">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="savePINChange()">Ganti PIN</button>
            `);
        }

        function savePINChange() {
            showMessage('Transaction PIN changed successfully!', 'success');
            closeModal();
        }

        function toggle2FA() {
            showModal('Two-Factor Authentication', `
                <div style="text-align: center;">
                    <p>Two-Factor Authentication (2FA) adds an extra layer of security to your account.</p>
                    <p>Current Status: <span style="font-weight: 600; color: var(--secondary-color);">Enabled</span></p>
                    <div style="margin-top: 2rem;">
                        <button class="btn btn-danger" onclick="disable2FA()">Disable 2FA</button>
                        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    </div>
                </div>
            `);
        }

        function disable2FA() {
            showMessage('2FA has been disabled for your account.', 'warning');
            closeModal();
        }

        // Utility functions
        function filterTransactions(type) {
            showMessage(`Filtering transactions by: ${type}`, "info");
        }

        function showModal(title, content) {
            document.getElementById("modalTitle").textContent = title;
            document.getElementById("modalBody").innerHTML = content;
            document.getElementById("actionModal").classList.add("active");
        }

        function closeModal() {
            document.getElementById("actionModal").classList.remove("active");
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat("id-ID", {
                style: "currency",
                currency: "IDR",
                minimumFractionDigits: 0
            }).format(amount);
        }

        function showMessage(message, type) {
            const messageEl = document.createElement("div");
            messageEl.className = `message ${type}`;
            messageEl.textContent = message;
            messageEl.style.position = "fixed";
            messageEl.style.top = "20px";
            messageEl.style.right = "20px";
            messageEl.style.zIndex = "10000";
            messageEl.style.borderRadius = "8px";
            messageEl.style.padding = "1rem";
            messageEl.style.minWidth = "300px";
            messageEl.style.maxWidth = "400px";
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 4000);
        }

        function showNotifications() {
            showModal("Notifications", `
                <div id="notificationsList">
                    <div class="transaction-item">
                        <div class="transaction-icon" style="background: var(--info-color);">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="transaction-details">
                            <div class="transaction-title">Transfer Berhasil</div>
                            <div class="transaction-date">Transfer ke Jane Smith berhasil diproses</div>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">2 min ago</div>
                    </div>
                    <div class="transaction-item">
                        <div class="transaction-icon" style="background: var(--warning-color);">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="transaction-details">
                            <div class="transaction-title">Tagihan Listrik</div>
                            <div class="transaction-date">Tagihan listrik akan jatuh tempo dalam 3 hari</div>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">1 hour ago</div>
                    </div>
                    <div class="transaction-item">
                        <div class="transaction-icon" style="background: var(--secondary-color);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="transaction-details">
                            <div class="transaction-title">Investasi Update</div>
                            <div class="transaction-date">Portfolio Anda naik 2.5% hari ini</div>
                        </div>
                        <div style="color: var(--text-muted); font-size: 0.8rem;">3 hours ago</div>
                    </div>
                </div>
            `);
        }

        async function logout() {
            try {
                console.log("Logging out user...");
                showMessage("Logged out successfully!", "success");
                
                setTimeout(() => {
                    window.location.href = "index.html";
                }, 1000);
            } catch (error) {
                console.error("Logout error:", error);
                showMessage("Logout failed. Please try again.", "error");
            }
        }

        // Event listeners
        document.getElementById("actionModal").addEventListener("click", function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.addEventListener("input", function(e) {
            if (e.target.classList.contains("pin-digit")) {
                const currentInput = e.target;
                const maxLength = parseInt(currentInput.maxLength);
                const currentLength = currentInput.value.length;

                if (currentLength === maxLength) {
                    let nextInput = currentInput.nextElementSibling;
                    while (nextInput && nextInput.tagName !== "INPUT") {
                        nextInput = nextInput.nextElementSibling;
                    }
                    if (nextInput && nextInput.classList.contains("pin-digit")) {
                        nextInput.focus();
                    }
                }

                if (currentLength === 0 && e.inputType === "deleteContentBackward") {
                    let prevInput = currentInput.previousElementSibling;
                    while (prevInput && prevInput.tagName !== "INPUT") {
                        prevInput = prevInput.previousElementSibling;
                    }
                    if (prevInput && prevInput.classList.contains("pin-digit")) {
                        prevInput.focus();
                    }
                }
            }
        });

        document.addEventListener("keydown", function(e) {
            if (e.key === "Escape") {
                closeModal();
            }
        });

        // Format card number input
        document.addEventListener("input", function(e) {
            if (e.target.id === "cardNumber") {
                let value = e.target.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
                let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                e.target.value = formattedValue;
            }
            
            if (e.target.id === "cardExpiry") {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length >= 2) {
                    value = value.substring(0, 2) + '/' + value.substring(2, 4);
                }
                e.target.value = value;
            }
        });
    </script>
</body>
</html>

